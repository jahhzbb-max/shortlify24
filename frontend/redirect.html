<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Redirecting...</title>
<!-- যদি style.css ফাইল ব্যবহার করতে চান, তবে শুধু এই লাইনটি রাখুন এবং <style> ট্যাগটি মুছে দিন -->
<link rel="stylesheet" href="/assets/style.css"> 
<style>
/* 
যদি style.css ফাইল ব্যবহার না করে এখানেই CSS রাখতে চান, তাহলে উপরের <link> ট্যাগটি মুছে দিয়ে এখানে আপনার আগের CSS কোড পেস্ট করুন। 
উদাহরণস্বরূপ:
body { ... }
.particle { ... }
...ইত্যাদি...
*/
#qrcode { margin-top: 20px; display: inline-block; } /* QR কোডের জন্য নতুন স্টাইল */
</style>
</head>

<body>
<div class="box">
  <h2>Redirecting In</h2>
  <div id="countdown">10</div>
  <b>Destination:</b>
  <div id="finalLink">Loading...</div>
  
  <div id="qrcode"></div> <!-- FIX 4: QR কোড দেখানোর জন্য নতুন div -->

  <button id="goBtn">Get Link</button>
  <button class="copyBtn" id="copyBtn">Copy URL</button>
  <button class="shareBtn" id="shareBtn">Share</button>
</div>

<!-- FIX 1 ও FIX 2: দুটি স্ক্রিপ্ট ট্যাগই </body> এর আগে নিয়ে আসা হলো -->
<!-- নির্ভরযোগ্য QR Code CDN লিঙ্ক -->
<script src="cdnjs.cloudflare.com"></script>

<script>
// ব্যাকএন্ড API URL - এটি আপনার Render URL হতে হবে
const BACKEND = "https://shortlify24.onrender.com"; 

// DOM elements
const goBtn = document.getElementById("goBtn");
const copyBtn = document.getElementById("copyBtn");
const shareBtn = document.getElementById("shareBtn");
const finalLinkDiv = document.getElementById("finalLink");
const countdownDiv = document.getElementById("countdown");
const qrcodeDiv = document.getElementById("qrcode"); // FIX 4: নতুন div রেফারেন্স

// Function to generate the QR code
function generateQRCode(url) {
    new QRCode(qrcodeDiv, {
        text: url,
        width: 128,
        height: 128,
        colorDark : "#fff",
        colorLight : "transparent",
        correctLevel : QRCode.CorrectLevel.H
    });
}

// FIXED: GET shortId from URL query parameter ?c=
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('c'); // 'c' is the key we use from index.html

if (!id) {
    finalLinkDiv.textContent = "Error: Missing link ID";
    goBtn.style.display = "none";
    copyBtn.style.display = "none";
    shareBtn.style.display = "none";
}

let finalURL = null;

// FIXED API ROUTE — must call /api/info/:id
// Only fetch if ID exists
if (id) {
    fetch(`${BACKEND}/api/info/${id}`)
      .then(res => res.json())
      .then(data => {
        if (data.originalUrl) {
          finalURL = data.originalUrl;
          finalLinkDiv.textContent = finalURL;
          generateQRCode(finalURL); // QR কোড জেনারেট করা হলো
        } else {
          finalLinkDiv.textContent = "Invalid or Expired Link";
        }
      })
      .catch(() => (finalLinkDiv.textContent = "Error loading link!"));
}

// Countdown Timer
let sec = 10;
let timer = setInterval(() => {
  countdownDiv.innerText = sec;
  if (sec-- <= 0) {
    clearInterval(timer);
    if (finalURL) { // Only show button if a valid URL was found
        goBtn.style.display = "inline-block";
    }
  }
}, 1000);

// Get Link (Go button)
goBtn.onclick = () => {
  if (!finalURL) return;
  location.href = finalURL;
};

// Copy Button
copyBtn.onclick = () => {
  navigator.clipboard.writeText(finalURL || "");
  copyBtn.textContent = "Copied!";
  setTimeout(() => (copyBtn.textContent = "Copy URL"), 1500);
};

// Share Button
shareBtn.onclick = () => {
  if (navigator.share) {
    navigator.share({ title: "Shortened Link", url: finalURL });
  } else {
    alert("Sharing not supported");
  }
};

// floating particles (moved here to run after elements exist)
for (let i = 0; i < 30; i++) {
  let p = document.createElement("div");
  p.className = "particle";
  p.style.left = Math.random() * window.innerWidth + "px";
  p.style.top = Math.random() * window.innerHeight + "px";
  document.body.appendChild(p);
}
</script>

</body>
</html>
